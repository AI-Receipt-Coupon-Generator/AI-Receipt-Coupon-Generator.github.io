
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Coupon Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Include JsBarcode library for generating the barcode SVG -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <!-- Include QR Code library for generating QR codes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font for UI, Roboto Mono for the receipt text */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .receipt-font {
            font-family: 'Roboto Mono', monospace;
        }
        /* Custom dashed line for the tear-off effect */
        .perforation {
            border: none;
            border-top: 2px dashed #a0a0a0;
            margin: 1rem 0;
            opacity: 0.6;
        }
        /* Styling for the coupon output box */
        #coupon-preview {
            background-color: #ffffff;
            background-size: cover;
            background-position: center;
            color: #1f2937;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 0, 0.05);
            position: relative; 
            overflow: hidden;
            min-height: 250px; 
        }
        /* Style for the overlay to ensure text readability over a background image */
        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7); 
            z-index: 1; 
            border-radius: 0.5rem; 
        }
        /* Ensure coupon text content is above the overlay */
        .coupon-content {
            position: relative;
            z-index: 2;
        }
        /* Loading spinner style */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom pulse for voice input */
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-slow {
          0%, 100% { opacity: 1; }
          50% { opacity: .5; }
        }
        
        /* Saved coupon history item styling */
        .saved-coupon-item {
            border-left: 4px solid #3b82f6;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body > * {
                visibility: hidden;
            }
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }
            #print-area {
                visibility: visible;
                position: absolute;
                left: 50%;
                top: 20px;
                transform: translateX(-50%);
                width: 100%;
                max-width: 350px;
            }
            #coupon-preview {
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                background-color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .preview-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">POS Receipt Coupon Generator</h1>
            <p id="auth-status" class="text-sm text-gray-500 mt-1">Storage: Browser Local Storage</p>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Coupon Input Form (The entire left column) -->
            <div class="p-6 bg-white rounded-xl shadow-lg h-fit">
                
                <!-- Collapsible Header for Coupon Details (Open by Default) -->
                <div id="coupon-details-header" class="flex justify-between items-center cursor-pointer mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Coupon Details</h2>
                    <svg id="toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                </div>

                <form id="coupon-form">
                    <div id="coupon-input-container" class="space-y-4 transition-all duration-500 ease-in-out overflow-hidden visible" style="max-height: 800px;">
                        
                        <div class="flex space-x-4">
                            <div class="w-1/3">
                                <label for="discountType" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="discountType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                    <option value="%_OFF">% OFF</option>
                                    <option value="$_OFF">$ OFF</option>
                                    <option value="FREE_ITEM">FREE ITEM</option>
                                </select>
                            </div>
                            <div class="w-2/3">
                                <label for="discountValue" class="block text-sm font-medium text-gray-700">Value (e.g., 15 or Coffee)</label>
                                <input type="text" id="discountValue" value="15" placeholder="e.g., 15 or Coffee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                        </div>

                        <div>
                            <label for="customHeadline" class="block text-sm font-medium text-gray-700">Custom Headline (Optional, Overrides default)</label>
                            <input type="text" id="customHeadline" placeholder="e.g., BIG SAVINGS EVENT" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <div>
                            <label for="minPurchase" class="block text-sm font-medium text-gray-700">Min. Purchase (Optional)</label>
                            <input type="text" id="minPurchase" value="$50.00" placeholder="e.g., $50.00 or $0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <div>
                            <label for="expirationDate" class="block text-sm font-medium text-gray-700">Expiration Date</label>
                            <input type="date" id="expirationDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <div>
                            <label for="couponCode" class="block text-sm font-medium text-gray-700">Coupon Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="couponCode" value="SUMMER2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border receipt-font uppercase font-bold text-center">
                                <button type="button" id="generateCode" class="mt-1 px-4 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">
                                    Generate
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <label for="codeRenderType" class="block text-sm font-medium text-gray-700">Code Format</label>
                            <select id="codeRenderType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="barcode">Barcode (CODE128)</option>
                                <option value="qrcode">QR Code</option>
                                <option value="text">Plain Text Code</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="textAlign" class="block text-sm font-medium text-gray-700">Text Alignment (Default)</label>
                            <select id="textAlign" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="center">Center</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                        </div>

                        <div>
                            <label for="barcodePosition" class="block text-sm font-medium text-gray-700">Code Placement (Vertical & Horizontal)</label>
                            <select id="barcodePosition" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="middle-center">Middle (Center)</option>
                                <option value="middle-left">Middle (Left)</option>
                                <option value="middle-right">Middle (Right)</option>
                                <option value="top-center">Top (Center)</option>
                                <option value="bottom-center">Bottom (Center)</option>
                            </select>
                        </div>

                        <!-- REDEMPTION CALL TO ACTION (Optional) - Now positioned above Terms -->
                        <div>
                            <label for="redemptionCta" class="block text-sm font-medium text-gray-700">Redemption Call to Action (Optional)</label>
                            <input type="text" id="redemptionCta" value="PRESENT RECEIPT TO REDEEM" placeholder="e.g., Use code at checkout" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>
                        
                        <!-- TERMS (Short) - Now positioned below CTA and marked as Optional -->
                        <div>
                            <label for="terms" class="block text-sm font-medium text-gray-700">Terms (Optional)</label>
                            <textarea id="terms" rows="2" placeholder="e.g., Valid for one-time use. Excludes clearance items." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">Valid for one-time use. Excludes clearance items.</textarea>
                        </div>

                    </div>
                </form>

                <!-- AI Generation -->
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <div id="ai-generator-header" class="flex justify-between items-center cursor-pointer mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">AI Coupon Generator</h2>
                        <svg id="ai-toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <div id="ai-input-container" class="space-y-4 transition-all duration-500 ease-in-out overflow-hidden invisible" style="max-height: 0;">
                        
                        <div class="mb-4">
                            <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">Gemini/Imagen API Key (Optional)</label>
                            <input type="password" id="apiKeyInput" placeholder="Enter your key here..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">
                            <p class="text-xs text-gray-500 mt-1">If empty, the environment's default key will be used.</p>
                        </div>

                        <p class="text-sm text-gray-500 mb-3">Describe the coupon you want (e.g., "A coupon for a free small coffee with $10 purchase, expiring end of month.")</p>
                        
                        <div class="flex space-x-2">
                            <textarea id="aiPrompt" rows="3" placeholder="Enter your coupon description here..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">A coupon for a free small coffee with $10 purchase, expiring end of october 2025 with a happy store customer drinking coffee image.</textarea>
                            <button type="button" id="startVoiceInputBtn" title="Use Voice Input" class="mt-1 px-4 py-1.5 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition duration-150 shadow-md h-12 self-start flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0M12 19v3M12 4v0"></path></svg>
                            </button>
                        </div>

                        <button id="generateAiCouponBtn" class="w-full mt-3 px-4 py-2 bg-violet-600 text-white font-medium rounded-md hover:bg-violet-700 transition duration-150 shadow-md flex items-center justify-center">
                            <span id="ai-btn-text">Generate Coupon Draft with AI</span>
                            <div id="ai-loading-spinner" class="spinner ml-3 hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Camera/Upload Controls and Preview -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <div id="photo-generator-header" class="flex justify-between items-center cursor-pointer mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Optional Background Photo</h2>
                        <svg id="photo-toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <div id="photo-input-container" class="space-y-4 transition-all duration-500 ease-in-out overflow-hidden invisible" style="max-height: 0;">
                        
                        <div class="flex flex-col space-y-3">
                            <button id="startCameraBtn" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-md hover:bg-purple-700 transition duration-150 shadow-md">
                                <span id="camera-btn-text">Start Camera</span>
                            </button>
                            <button id="takePhotoBtn" class="px-4 py-2 bg-orange-500 text-white font-medium rounded-md hover:bg-orange-600 transition duration-150 shadow-md hidden" disabled>
                                Take Photo & Set Background
                            </button>
                        </div>

                        <div class="mt-4 relative bg-gray-900 rounded-lg overflow-hidden hidden" id="camera-container">
                            <video id="cameraFeed" class="w-full h-auto object-cover" autoplay playsinline></video>
                            <canvas id="photoCanvas" class="hidden"></canvas>
                        </div>

                        <div class="pt-4 border-t border-gray-200 mt-4">
                            <label for="imageUploadInput" class="block text-base font-medium text-gray-700 mb-2">OR Upload Photo from Device</label>
                            <input type="file" id="imageUploadInput" accept="image/*" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-semibold
                                file:bg-pink-50 file:text-pink-700
                                hover:file:bg-pink-100
                            ">
                        </div>

                        <button id="clearPhotoBtn" class="w-full mt-4 px-4 py-2 bg-gray-500 text-white font-medium rounded-md hover:bg-gray-600 transition duration-150 shadow-md">
                            Clear Background Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Coupon Preview & Controls -->
            <div class="p-6 bg-gray-100 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">POS Receipt Preview</h2>
                
                <div id="print-area" class="w-full max-w-sm mx-auto">
                    <div id="coupon-preview" class="p-4 border border-gray-200 rounded-lg shadow-2xl">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <p id="statusMessage" class="h-5 text-sm font-medium transition duration-300 text-gray-700 mb-2 opacity-0">Status Message</p>
                    
                    <div class="flex flex-wrap justify-center gap-3">
                        <button 
                            id="saveCouponBtn" 
                            class="px-4 py-3 bg-blue-600 text-white font-bold text-sm rounded-lg hover:bg-blue-700 transition duration-150 shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                            onclick="handleSaveCoupon()"
                        >
                            Save to Gallery
                        </button>
                        <button id="copyCouponText" class="px-4 py-3 bg-green-500 text-white font-bold text-sm rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                            Copy Coupon Text
                        </button>
                        <button id="downloadCouponPng" class="px-4 py-3 bg-blue-500 text-white font-bold text-sm rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                            Download as PNG
                        </button>
                        <button id="printCouponBtn" class="px-4 py-3 bg-indigo-500 text-white font-bold text-sm rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                            Print Coupon
                        </button>
                    </div>
                </div>
            </div>
            
        </div>

        <!-- Coupon Gallery Section -->
        <section class="mt-12 p-6 bg-white rounded-xl shadow-lg">
            <div id="gallery-header" class="flex justify-between items-center cursor-pointer mb-4">
                <h2 class="text-xl font-bold text-gray-700 flex items-center">
                    Coupon Gallery
                    <span id="coupon-count" class="text-sm bg-gray-200 text-gray-600 px-3 py-1 rounded-full font-medium ml-3">0</span>
                </h2>
                <!-- Icon starts pointing up (open) -->
                <svg id="gallery-toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300 rotate-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
            </div>
            
            <div id="gallery-content-container" class="space-y-3 transition-all duration-500 ease-in-out overflow-hidden visible" style="max-height: 10000px;">
                <div id="coupon-history-list" class="space-y-3">
                    <!-- Saved coupons will be injected here -->
                    <p id="loading-message" class="text-center text-gray-500">Loading saved coupons...</p>
                </div>
            </div>
        </section>

        <!-- Modal for Confirmation/Error (replaces alert/confirm) -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800"></h3>
                <p id="modal-message" class="text-gray-600 mb-6"></p>
                <button
                    onclick="document.getElementById('modal').classList.add('hidden'); document.getElementById('modal').classList.remove('flex');"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition duration-150"
                >
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Core Application Logic -->
    <script type="text/javascript">
        
        // --- Core Configuration ---
        const TEXT_MODEL = 'gemini-2.5-flash-preview-05-20';
        const IMAGE_MODEL = 'imagen-3.0-generate-002';
        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF = 1000;
        const LOCAL_STORAGE_KEY = 'couponGeneratorHistory';

        const statusMessage = document.getElementById('statusMessage');

        const elements = {
            discountType: document.getElementById('discountType'),
            discountValue: document.getElementById('discountValue'),
            minPurchase: document.getElementById('minPurchase'),
            expirationDate: document.getElementById('expirationDate'),
            couponCode: document.getElementById('couponCode'),
            codeRenderType: document.getElementById('codeRenderType'), 
            textAlign: document.getElementById('textAlign'), // User defined alignment
            barcodePosition: document.getElementById('barcodePosition'), 
            terms: document.getElementById('terms'),
            customHeadline: document.getElementById('customHeadline'),
            redemptionCta: document.getElementById('redemptionCta'), 
            couponPreview: document.getElementById('coupon-preview'),
            
            // Buttons
            saveCouponBtn: document.getElementById('saveCouponBtn'), 
            generateCodeBtn: document.getElementById('generateCode'),
            copyCouponBtn: document.getElementById('copyCouponText'),
            downloadPngBtn: document.getElementById('downloadCouponPng'),
            printCouponBtn: document.getElementById('printCouponBtn'),
            startCameraBtn: document.getElementById('startCameraBtn'),
            takePhotoBtn: document.getElementById('takePhotoBtn'),
            clearPhotoBtn: document.getElementById('clearPhotoBtn'),
            startVoiceInputBtn: document.getElementById('startVoiceInputBtn'),
            generateAiCouponBtn: document.getElementById('generateAiCouponBtn'),

            // UI Elements
            authStatus: document.getElementById('auth-status'),
            couponHistoryList: document.getElementById('coupon-history-list'),
            couponCount: document.getElementById('coupon-count'),
            loadingMessage: document.getElementById('loading-message'),
            
            // Camera/Upload elements
            cameraBtnText: document.getElementById('camera-btn-text'),
            cameraContainer: document.getElementById('camera-container'),
            cameraFeed: document.getElementById('cameraFeed'),
            photoCanvas: document.getElementById('photoCanvas'),
            imageUploadInput: document.getElementById('imageUploadInput'),

            // AI Generation elements
            aiPrompt: document.getElementById('aiPrompt'),
            aiBtnText: document.getElementById('ai-btn-text'),
            aiLoadingSpinner: document.getElementById('ai-loading-spinner'),
            apiKeyInput: document.getElementById('apiKeyInput'), 

            // Collapse Elements
            couponInputContainer: document.getElementById('coupon-input-container'),
            toggleIcon: document.getElementById('toggle-icon'),
            aiInputContainer: document.getElementById('ai-input-container'),
            aiToggleIcon: document.getElementById('ai-toggle-icon'),
            photoInputContainer: document.getElementById('photo-input-container'),
            photoToggleIcon: document.getElementById('photo-toggle-icon'),
            galleryHeader: document.getElementById('gallery-header'),
            galleryContentContainer: document.getElementById('gallery-content-container'),
            galleryToggleIcon: document.getElementById('gallery-toggle-icon'),
        };
        
        let mediaStream = null;
        let isCameraActive = false;
        let isListening = false;
        
        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                // CRITICAL: Clear prompt when starting recording so silent/void input results in an empty prompt.
                elements.aiPrompt.value = ''; 
                checkAiButtonState(); 
                elements.startVoiceInputBtn.classList.add('bg-red-500', 'animate-pulse-slow');
                elements.startVoiceInputBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                displayStatus('Listening... Speak your coupon request now.', 'text-red-500');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.aiPrompt.value = transcript;
                checkAiButtonState();
                displayStatus('Voice input recorded. Click Generate to proceed.', 'text-green-600');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    displayStatus('Microphone permission denied. Please enable it in your browser settings.', 'text-red-600');
                } else if (event.error === 'no-speech') {
                    // This handles "void input" where recording occurs but no words are spoken.
                    displayStatus('No speech detected. Try speaking closer to the mic.', 'text-orange-500');
                } else {
                    displayStatus(`Voice input error: ${event.error}`, 'text-red-600');
                }
                checkAiButtonState(); // Update button state after an error
            };

            recognition.onend = () => {
                isListening = false;
                elements.startVoiceInputBtn.classList.remove('bg-red-500', 'animate-pulse-slow');
                elements.startVoiceInputBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            };

            document.getElementById('startVoiceInputBtn').addEventListener('click', () => {
                if (!isListening) {
                    try {
                        recognition.start();
                    } catch(e) {
                        displayStatus('Microphone start error. Wait a second and try again.', 'text-orange-500');
                    }
                } else {
                    recognition.stop();
                }
            });

        } else {
            // Hide the voice input button if API is not supported
            elements.startVoiceInputBtn.style.display = 'none';
        }

        // Initialize expiration date to 30 days from now
        const today = new Date();
        const futureDate = new Date(today);
        futureDate.setDate(today.getDate() + 30);
        elements.expirationDate.value = futureDate.toISOString().split('T')[0];
        
        // Initialize custom headline with an empty value to match the new behavior
        elements.customHeadline.value = ""; 
        elements.redemptionCta.value = "PRESENT RECEIPT TO REDEEM"; 
        
        /**
         * Checks the AI prompt length and enables/disables the generation button.
         */
        const checkAiButtonState = () => {
            // Button is disabled if the text is too short to be a meaningful prompt
            elements.generateAiCouponBtn.disabled = elements.aiPrompt.value.trim().length < 5;
        };
        checkAiButtonState();


        /**
         * Utility function to display a custom modal message.
         */
        function showModal(title, message) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        }

        /**
         * Utility function to display a status message with specific text and color.
         */
        const displayStatus = (message, colorClass) => {
            statusMessage.textContent = message;
            statusMessage.className = `h-5 text-sm font-medium transition duration-300 mb-2 ${colorClass}`;
            statusMessage.classList.remove('opacity-0');
            
            // Hide message after a delay
            setTimeout(() => {
                statusMessage.classList.add('opacity-0');
            }, 5000);
        };
        
        // --- Local Storage Logic ---

        /**
         * Loads all saved coupons from Local Storage.
         * @returns {Array<Object>} The array of saved coupon objects.
         */
        function loadCouponsFromLocalStorage() {
            try {
                const storedData = localStorage.getItem(LOCAL_STORAGE_KEY);
                return storedData ? JSON.parse(storedData) : [];
            } catch (error) {
                console.error("Error reading from Local Storage:", error);
                showModal("Storage Error", "Could not read saved coupons from your browser's local storage.");
                return [];
            }
        }

        /**
         * Saves the current coupon to Local Storage.
         */
        window.handleSaveCoupon = function() {
            const currentCoupons = loadCouponsFromLocalStorage();

            const couponData = {
                id: crypto.randomUUID(), // Generate a unique ID for the new coupon
                savedAt: Date.now(), // Use current timestamp
                discountType: elements.discountType.value,
                discountValue: elements.discountValue.value.trim(),
                minPurchase: elements.minPurchase.value.trim(),
                expirationDate: elements.expirationDate.value,
                couponCode: elements.couponCode.value.trim() || 'NOCODE',
                terms: elements.terms.value.trim(),
                customHeadline: elements.customHeadline.value.trim(), // Save the possibly empty custom headline
                redemptionCta: elements.redemptionCta.value.trim(), // Save new CTA field
                codeRenderType: elements.codeRenderType.value,
                textAlign: elements.textAlign.value, // Save new text alignment
                barcodePosition: elements.barcodePosition.value,
            };

            currentCoupons.push(couponData);
            
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentCoupons));
                loadCoupons(); // Refresh the gallery
                displayStatus('Coupon SAVED to Gallery successfully!', 'text-green-600');
            } catch (error) {
                console.error("Error saving to Local Storage:", error);
                displayStatus('Save FAILED!', 'text-red-600');
                showModal("Storage Error", "Failed to save the coupon. Local Storage may be full.");
            }
        }

        /**
         * Loads the data from a saved coupon into the main form for editing and updates the preview.
         * @param {Object} couponData - The full coupon object.
         */
        window.loadCouponToEditor = function(couponData) {
            elements.discountType.value = couponData.discountType || '%_OFF';
            elements.discountValue.value = couponData.discountValue || '';
            elements.minPurchase.value = couponData.minPurchase || '';
            elements.expirationDate.value = couponData.expirationDate || elements.expirationDate.value;
            elements.couponCode.value = couponData.couponCode || generateRandomCode();
            elements.terms.value = couponData.terms || '';
            elements.customHeadline.value = couponData.customHeadline || ''; // Load the saved headline (which might be empty)
            elements.redemptionCta.value = couponData.redemptionCta || ''; // Load the saved CTA
            elements.codeRenderType.value = couponData.codeRenderType || 'barcode';
            elements.textAlign.value = couponData.textAlign || 'center'; // Load new text alignment
            elements.barcodePosition.value = couponData.barcodePosition || 'middle-center';

            // Load background image if available
            if (couponData.backgroundImage) {
                elements.couponPreview.style.backgroundImage = `url('${couponData.backgroundImage}')`;
            } else {
                elements.couponPreview.style.backgroundImage = 'none';
            }

            updateCouponPreview();
            displayStatus(`Coupon loaded: ${couponData.couponCode}. Edit details and click 'Save to Gallery' to save a new version.`, 'text-yellow-600');
            
            toggleForm(true);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        /**
         * Deletes a coupon document from Local Storage.
         * @param {string} id - The unique ID of the coupon to delete.
         * @param {string} couponCode - The human-readable code for display.
         */
        window.deleteCoupon = function(id, couponCode) {
            const currentCoupons = loadCouponsFromLocalStorage();
            
            const updatedCoupons = currentCoupons.filter(coupon => coupon.id !== id);
            
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(updatedCoupons));
                loadCoupons(); // Refresh the gallery
                displayStatus(`Coupon ${couponCode} deleted successfully.`, 'text-green-600');
            } catch (error) {
                console.error("Error deleting from Local Storage:", error);
                displayStatus('Deletion FAILED!', 'text-red-600');
                showModal("Storage Error", "Failed to delete the coupon.");
            }
        };


        /**
         * Loads and renders the saved coupons from Local Storage.
         */
        function loadCoupons() {
            const coupons = loadCouponsFromLocalStorage();

            // Sort coupons by savedAt descending (newest first)
            coupons.sort((a, b) => b.savedAt - a.savedAt);

            renderCoupons(coupons);
            elements.loadingMessage.classList.add('hidden'); // Hide loading after data is ready
        }

        /**
         * Renders the list of saved coupons to the UI.
         * @param {Array<Object>} coupons - The list of coupon objects.
         */
        function renderCoupons(coupons) {
            elements.couponCount.textContent = coupons.length;

            if (coupons.length === 0) {
                elements.couponHistoryList.innerHTML = `<p class="text-center text-gray-500 p-6 border border-gray-200 rounded-lg">No coupons saved yet. Your saved coupons will appear here.</p>`;
                return;
            }

            elements.couponHistoryList.innerHTML = coupons.map(coupon => {
                const savedDate = new Date(coupon.savedAt).toLocaleDateString();
                const expiry = coupon.expirationDate ? formatDate(coupon.expirationDate) : 'N/A';
                
                // Determine display discount for the gallery title
                let galleryDiscount = '';
                if (coupon.discountType === '%_OFF') {
                    galleryDiscount = `${coupon.discountValue || 'XX'}% OFF`;
                } else if (coupon.discountType === '$_OFF') {
                    galleryDiscount = `${coupon.discountValue || '$X.XX'} OFF`;
                } else if (coupon.discountType === 'FREE_ITEM') {
                    galleryDiscount = `FREE ${coupon.discountValue || 'ITEM'}`;
                }

                // If customHeadline is available, use it, otherwise fall back to the generated discount line
                const headline = coupon.customHeadline || galleryDiscount; 
                const min = coupon.minPurchase ? `Min: ${coupon.minPurchase}` : '';
                
                // Safely stringify the coupon object for passing to the onclick event
                const couponDataJson = JSON.stringify(coupon).replace(/'/g, "\\'");

                return `
                    <div class="saved-coupon-item p-4 bg-white rounded-xl shadow-md flex flex-col sm:flex-row justify-between items-start transition duration-150 hover:shadow-lg">
                        <div class="flex-grow mb-3 sm:mb-0">
                            <p class="text-lg font-bold text-gray-900">${headline}</p>
                            
                            <!-- Display the Unique Coupon ID (Local Storage ID) -->
                            <p class="text-sm text-gray-500 font-medium mt-1">
                                ID: <span class="font-mono text-xs text-blue-600">${coupon.id.substring(0, 8)}...</span>
                            </p>
                            
                            <p class="text-xs text-gray-700 mt-1">Code: ${coupon.couponCode}</p>
                            <p class="text-xs text-gray-500">${min}</p>
                            <p class="text-xs text-red-500 mt-1">Saved: ${savedDate} | Expires: ${expiry}</p>
                        </div>
                        <div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-2 text-right ml-0 sm:ml-4 flex-shrink-0 w-full sm:w-auto">
                            <button 
                                onclick='loadCouponToEditor(${couponDataJson})'
                                class="px-3 py-1 bg-yellow-500 text-white text-xs font-semibold rounded-md hover:bg-yellow-600 transition duration-150 shadow-sm w-full sm:w-auto"
                            >
                                Load & Edit
                            </button>
                            <button 
                                onclick='deleteCoupon("${coupon.id}", "${coupon.couponCode}")'
                                class="px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded-md hover:bg-red-600 transition duration-150 shadow-sm w-full sm:w-auto"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // --- Utility Functions (rest of existing code) ---

        const formatDate = (date) => {
            if (!date) return 'MM/DD/YYYY';
            const [year, month, day] = date.split('-');
            return `${month}/${day}/${year}`;
        };

        const generateRandomCode = () => {
            return Math.random().toString(36).substring(2, 12).toUpperCase();
        };
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        const toggleSection = (container, icon, show, maxHeight = '800px') => {
            if (show) {
                container.classList.remove('invisible');
                container.style.maxHeight = maxHeight; 
                icon.classList.add('rotate-0');
                icon.classList.remove('rotate-180');
            } else {
                container.style.maxHeight = '0'; 
                container.classList.add('invisible'); 
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-180');
            }
        };

        const toggleForm = (show) => { toggleSection(elements.couponInputContainer, elements.toggleIcon, show, '800px'); };
        const toggleAiSection = (show) => { toggleSection(elements.aiInputContainer, elements.aiToggleIcon, show, '400px'); };
        const togglePhotoSection = (show) => { toggleSection(elements.photoInputContainer, elements.photoToggleIcon, show, '600px'); };
        
        const stopCamera = () => {
             if (mediaStream) { mediaStream.getTracks().forEach(track => track.stop()); }
             elements.cameraFeed.srcObject = null;
             elements.cameraContainer.classList.add('hidden');
             elements.takePhotoBtn.classList.add('hidden');
             elements.takePhotoBtn.disabled = true;
             elements.cameraBtnText.textContent = 'Start Camera';
             elements.startCameraBtn.classList.remove('bg-red-600');
             elements.startCameraBtn.classList.add('bg-purple-600');
             isCameraActive = false;
        };

        const startCamera = async () => {
            if (isCameraActive) { stopCamera(); return; }
            try {
                displayStatus('Requesting camera access...', 'text-blue-600');
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                elements.cameraFeed.srcObject = mediaStream;
                elements.cameraFeed.play();
                elements.cameraContainer.classList.remove('hidden');
                elements.takePhotoBtn.classList.remove('hidden');
                elements.takePhotoBtn.disabled = false;
                elements.cameraBtnText.textContent = 'Stop Camera';
                elements.startCameraBtn.classList.remove('bg-purple-600');
                elements.startCameraBtn.classList.add('bg-red-600');
                isCameraActive = true;
                elements.imageUploadInput.value = '';
                displayStatus('Camera started. Position the coupon background.', 'text-green-600');

            } catch (err) {
                console.error("Camera access failed:", err);
                displayStatus('Error: Camera access denied or unavailable.', 'text-red-600');
                stopCamera();
            }
        };

        const takePhoto = () => {
            if (!isCameraActive) return;
            const video = elements.cameraFeed;
            const canvas = elements.photoCanvas;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataURL = canvas.toDataURL('image/png');
            elements.couponPreview.style.backgroundImage = `url('${imageDataURL}')`;
            stopCamera();
            displayStatus('Photo captured and set as background!', 'text-green-600');
            updateCouponPreview();
        };

        const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (isCameraActive) stopCamera();
            if (!file.type.startsWith('image/')) {
                displayStatus('Please select an image file.', 'text-red-600');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                elements.couponPreview.style.backgroundImage = `url('${e.target.result}')`;
                displayStatus('Image uploaded and set as background!', 'text-green-600');
                updateCouponPreview();
            };
            reader.readAsDataURL(file);
        };

        const clearPhotoBackground = () => {
            elements.couponPreview.style.backgroundImage = 'none';
            elements.imageUploadInput.value = '';
            displayStatus('Background image cleared.', 'text-gray-600');
            updateCouponPreview(); 
            stopCamera();
        };

        const getApiKey = () => { return elements.apiKeyInput.value.trim(); };
        const getApiUrl = (model) => { const key = getApiKey(); return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`; };
        const getImageApiUrl = (model) => { const key = getApiKey(); return `https://generativelanguage.googleapis.com/v1beta/models/${model}:predict?key=${key}`; };

        const generateImage = async (prompt) => {
            const payload = { instances: { prompt: prompt }, parameters: { "sampleCount": 1 } };
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(getImageApiUrl(IMAGE_MODEL), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
                        if (base64Data) { return `data:image/png;base64,${base64Data}`; }
                        throw new Error("Image API returned no image data.");
                    }
                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        const delay = INITIAL_BACKOFF * Math.pow(2, attempt) + Math.random() * 1000;
                        await sleep(delay); continue;
                    }
                    throw new Error(`Image API call failed with status: ${response.status}`);
                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) { throw new Error(`Image generation failed after ${MAX_RETRIES} attempts: ${error.message}`); }
                }
            }
        };

        const callGeminiApi = async (payload) => {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(getApiUrl(TEXT_MODEL), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) { return response.json(); }
                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        const delay = INITIAL_BACKOFF * Math.pow(2, attempt) + Math.random() * 1000;
                        await sleep(delay); continue;
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) { throw new Error(`Gemini API request failed after ${MAX_RETRIES} attempts: ${error.message}`); }
                }
            }
        };

        const buildAiPayload = (prompt) => {
            const systemInstruction = "You are a coupon generator AI. Based on the user's request, generate a complete set of coupon details in the requested JSON format. Ensure all fields are valid, especially the expirationDate (YYYY-MM-DD, future date, set to the end of the specified month/year) and one of the allowed discountType values. Ignore any image requests in the prompt, as the image is handled separately. The customHeadline, redemptionCta, and terms fields are optional and can be an empty string. If left empty, the application will not show them.";
            return {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "discountType": { "type": "STRING", "enum": ["%_OFF", "$_OFF", "FREE_ITEM"] },
                            "discountValue": { "type": "STRING", "description": "The numeric value (e.g., '20') for %_OFF or $_OFF, or the item name (e.g., 'Small Coffee') for FREE_ITEM." },
                            "customHeadline": { "type": "STRING", "description": "A short, attention-grabbing headline for the coupon, e.g., 'WEEKEND SAVINGS EVENT'. Should be less than 40 characters. Can be an empty string." },
                            "minPurchase": { "type": "STRING", "description": "Minimum purchase requirement, including currency sign, e.g., '$50.00'. Use empty string if none." },
                            "expirationDate": { "type": "STRING", "description": "The coupon's expiration date in YYYY-MM-DD format, set to the requested future date." },
                            "couponCode": { "type": "STRING", "description": "A unique, uppercase alphanumeric code, e.g., 'FALL2025'." },
                            "terms": { "type": "STRING", "description": "Short terms and conditions (max 10 words). Can be an empty string." }, // TERMS IS NOW OPTIONAL
                            "redemptionCta": { "type": "STRING", "description": "Short call to action for redemption, e.g., 'SHOW THIS BARCODE' or 'USE CODE ONLINE'. Can be an empty string." } 
                        },
                        // Only fields that must always exist are required for schema validation
                        "required": ["discountType", "discountValue", "minPurchase", "expirationDate", "couponCode"]
                    }
                }
            };
        };

        const generateCouponWithAI = async () => {
            const prompt = elements.aiPrompt.value.trim();
            if (prompt.length < 5) {
                displayStatus('Please enter a longer, more specific prompt.', 'text-red-500');
                return;
            }
            toggleForm(false);
            togglePhotoSection(false);
            toggleAiSection(true); 

            const hasExistingImage = elements.couponPreview.style.backgroundImage !== 'none' && elements.couponPreview.style.backgroundImage !== '';
            const loadingOverlay = hasExistingImage ? `<div class="preview-overlay"></div>` : '';
            elements.couponPreview.innerHTML = loadingOverlay + `
                <div class="p-4 text-center text-gray-500 receipt-font coupon-content">
                    <p class="text-lg font-semibold mb-2">Generating Image and Coupon Details...</p>
                    <p class="text-sm">This may take a few moments.</p>
                </div>
            `;
            elements.imageUploadInput.value = ''; 
            
            elements.generateAiCouponBtn.disabled = true;
            elements.aiBtnText.textContent = 'Generating...';
            elements.aiLoadingSpinner.classList.remove('hidden');
            elements.saveCouponBtn.disabled = true; // Disable save during generation

            try {
                displayStatus('Step 1/2: Generating background image (This can take 5-10s)...', 'text-purple-600');
                const imagePromptDescription = prompt.includes('image') ? prompt.substring(prompt.indexOf('image') - 2) : "A happy store customer drinking coffee, inside a modern cafe, clean photo, mobile friendly aspect ratio.";
                
                const imageUrl = await generateImage(imagePromptDescription);
                elements.couponPreview.style.backgroundImage = `url('${imageUrl}')`;
                
                const currentOverlay = elements.couponPreview.querySelector('.preview-overlay');
                if (!currentOverlay) { elements.couponPreview.innerHTML = `<div class="preview-overlay"></div>` + elements.couponPreview.innerHTML; }

                displayStatus('Step 2/2: Generating coupon details...', 'text-violet-600');
                const payload = buildAiPayload(prompt);
                const result = await callGeminiApi(payload);
                
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) { throw new Error('AI response was empty or malformed.'); }
                
                const couponData = JSON.parse(jsonText);

                elements.discountType.value = couponData.discountType || elements.discountType.value;
                elements.discountValue.value = couponData.discountValue || elements.discountValue.value;
                elements.customHeadline.value = couponData.customHeadline !== undefined ? couponData.customHeadline : ''; 
                elements.minPurchase.value = couponData.minPurchase || '';
                elements.couponCode.value = couponData.couponCode || generateRandomCode();
                elements.terms.value = couponData.terms !== undefined ? couponData.terms : elements.terms.value; // Use provided terms or existing
                elements.redemptionCta.value = couponData.redemptionCta !== undefined ? couponData.redemptionCta : elements.redemptionCta.value; 
                
                if (couponData.expirationDate) {
                    const dateMatch = couponData.expirationDate.match(/\d{4}-\d{2}-\d{2}/);
                    if (dateMatch) { elements.expirationDate.value = dateMatch[0]; }
                }

                updateCouponPreview(); 
                displayStatus('AI coupon and image generated successfully! Review and download.', 'text-green-600');

            } catch (error) {
                console.error('AI Generation Error:', error);
                if (error.message.includes('Image generation failed')) {
                    elements.couponPreview.style.backgroundImage = 'none';
                    elements.couponPreview.innerHTML = '';
                }
                displayStatus(`Error generating coupon: ${error.message || 'Could not parse AI response.'}`, 'text-red-600');
                updateCouponPreview();
            } finally {
                elements.generateAiCouponBtn.disabled = false;
                elements.aiBtnText.textContent = 'Generate Coupon Draft with AI';
                elements.aiLoadingSpinner.classList.add('hidden');
                elements.saveCouponBtn.disabled = false; // Always enable save with local storage
                toggleForm(true); 
            }
        };

        const updateCouponPreview = () => {
            const type = elements.discountType.value;
            const value = elements.discountValue.value.trim();
            const min = elements.minPurchase.value.trim();
            const expiry = elements.expirationDate.value;
            const code = elements.couponCode.value.trim() || 'NOCODE';
            const terms = elements.terms.value.trim(); // Get updated terms
            const customHeadline = elements.customHeadline.value.trim(); 
            const redemptionCta = elements.redemptionCta.value.trim(); // Get CTA value
            const position = elements.barcodePosition.value;
            const codeRenderType = elements.codeRenderType.value;
            const textAlign = elements.textAlign.value; 
            
            const [verticalFlow, horizontalAlign] = position.split('-');

            let discountLine = '';
            let headline = customHeadline; 
            let codeInitFunction = null;

            const isSmallCodeType = codeRenderType === 'qrcode' || codeRenderType === 'text';
            const isTwoColumnLayout = isSmallCodeType && (horizontalAlign === 'left' || horizontalAlign === 'right') && verticalFlow === 'middle';
            
            const hasBackgroundImage = elements.couponPreview.style.backgroundImage !== 'none' && elements.couponPreview.style.backgroundImage !== '';


            // --- 1. Determine Discount Line (always necessary) ---
            switch (type) {
                case '%_OFF':
                    discountLine = `${value || 'XX'}% DISCOUNT`;
                    break;
                case '$_OFF':
                    discountLine = `SAVE ${value || '$X.XX'}`;
                    break;
                case 'FREE_ITEM':
                    discountLine = `FREE ITEM: ${value || 'ITEM'}`;
                    break;
            }
            
            // --- 2. Define Core Text Block (reusable in both layouts) ---
            const textBlock = `
                <div class="w-full">
                    <p class="text-xs mb-1">------------------------------------------</p>
                    
                    <!-- Only show headline if custom content exists -->
                    ${headline ? `<p class="font-bold text-lg leading-tight mb-2 uppercase text-indigo-700">${headline}</p>` : ''}
                    
                    <hr class="perforation">
                    
                    <p class="text-sm font-semibold mb-1">${discountLine}</p>
                    
                    ${min ? `<p class="text-xs mb-1">WITH MINIMUM PURCHASE OF: ${min}</p>` : ''}
                    
                    <p class="text-xs font-semibold mt-1">EXPIRES: ${formatDate(expiry)}</p>
                    
                    <hr class="perforation">

                    <!-- NEW: Redemption CTA is first, then Terms -->
                    ${redemptionCta ? `<p class="text-xs font-semibold mb-1">${redemptionCta.toUpperCase()}</p>` : ''}

                    <!-- NEW: Terms are now truly optional (omitted if field is empty) -->
                    ${terms ? `<p class="text-xs italic px-2">${terms}</p>` : ''}

                    <p class="text-xs mt-3">------------------------------------------</p>
                </div>
            `;
            
            // --- 3. Generate HTML based on Layout Type ---
            let couponContentHtml = '';

            if (isTwoColumnLayout) {
                // --- TWO-COLUMN LAYOUT (QR or Text on Left/Right) ---
                
                const codeWrapperClass = 'w-4/12 flex-shrink-0 flex flex-col justify-center';
                const textWrapperClass = 'w-8/12 flex-grow flex flex-col justify-center';
                
                // Text shifts opposite to the code placement
                const contentAlignClass = horizontalAlign === 'left' ? 'text-right' : 'text-left';

                let codeInnerHtml = '';
                
                if (codeRenderType === 'qrcode') {
                    // QR Code setup
                    codeInnerHtml = `<p class="text-xs font-bold mb-1">SCAN:</p><div id="code-target" class="mx-auto p-1 rounded-sm border border-gray-300 bg-white"></div>`;
                    codeInitFunction = () => {
                        const targetDiv = document.getElementById('code-target');
                        targetDiv.innerHTML = '';
                        const qrSize = 90; // Smaller size for 1/3 column
                        targetDiv.style.width = `${qrSize}px`;
                        targetDiv.style.height = `${qrSize}px`;

                        new QRCode(targetDiv, {
                            text: code,
                            width: qrSize,
                            height: qrSize,
                            colorDark : "#1f2937",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    };
                } else if (codeRenderType === 'text') {
                    // Plain Text Code setup (injected directly, no init function)
                    codeInnerHtml = `
                        <p class="text-xs font-bold mb-1">CODE:</p>
                        <p class="text-base font-extrabold text-red-600 tracking-wider receipt-font py-1 px-2 bg-red-50 rounded-md inline-block border border-red-200">${code}</p>
                    `;
                    codeInitFunction = null;
                }
                
                const codeBlock = `<div class="${codeWrapperClass} text-center p-1">${codeInnerHtml}</div>`;
                const alignedTextBlock = `<div class="${textWrapperClass} ${contentAlignClass} p-1">${textBlock}</div>`;

                // Order matters for Left/Right placement
                const contentBlocks = horizontalAlign === 'left' 
                    ? codeBlock + alignedTextBlock 
                    : alignedTextBlock + codeBlock;

                couponContentHtml = `<div class="receipt-font coupon-content p-4 flex justify-between items-center">${contentBlocks}</div>`;

            } else {
                // --- SINGLE-COLUMN LAYOUT (Barcode or Center Placement) ---
                
                // Use user-defined alignment if not in two-column mode
                let singleColumnAlignmentClass = 'text-center';
                if (textAlign === 'left') {
                    singleColumnAlignmentClass = 'text-left';
                } else if (textAlign === 'right') {
                    singleColumnAlignmentClass = 'text-right';
                }
                
                // Determine code alignment for the single column (centered by default)
                let justifyClass = 'justify-center';
                if (horizontalAlign === 'left') {
                    justifyClass = 'justify-start';
                } else if (horizontalAlign === 'right') {
                    justifyClass = 'justify-end';
                }

                const singleCodeHtml = (type) => `
                    <p class="text-xs font-bold mt-2">
                        ${type === 'text' ? 'COUPON CODE:' : 'SCAN TO REDEEM:'}
                    </p>
                    <div id="code-display-container" class="flex ${justifyClass} my-2 w-full">
                        <div id="code-target" class="p-1 rounded-sm border border-gray-300 bg-white">
                            ${type === 'text' ? `<p class="text-base font-extrabold text-red-600 tracking-wider receipt-font py-1 px-3 bg-red-50 rounded-md inline-block border border-red-200">${code}</p>` : ''}
                        </div>
                    </div>
                `;

                // Redefine code init function for single column (Barcode and QR)
                if (codeRenderType === 'barcode') {
                    codeInitFunction = () => {
                        const targetDiv = document.getElementById('code-target');
                        targetDiv.innerHTML = '';
                        targetDiv.style.width = 'auto'; 
                        targetDiv.style.height = 'auto';

                        const svgTarget = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                        svgTarget.setAttribute('id', 'barcode-svg');
                        svgTarget.setAttribute('class', 'h-16 max-w-[250px]');
                        targetDiv.appendChild(svgTarget);

                        JsBarcode("#barcode-svg", code, {
                            format: "CODE128",
                            displayValue: true,
                            text: code,
                            textPosition: "bottom",
                            fontSize: 12,
                            height: 50,
                            margin: 0,
                            width: 1.5,
                            lineColor: "#1f2937",
                            background: "transparent"
                        });
                    };
                } else if (codeRenderType === 'qrcode') {
                    codeInitFunction = () => {
                        const targetDiv = document.getElementById('code-target');
                        targetDiv.innerHTML = '';
                        const qrSize = 100;
                        targetDiv.style.width = `${qrSize}px`;
                        targetDiv.style.height = `${qrSize}px`;
                        targetDiv.classList.add('flex', 'items-center', 'justify-center');

                        new QRCode(targetDiv, {
                            text: code,
                            width: qrSize,
                            height: qrSize,
                            colorDark : "#1f2937",
                            colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    };
                } else {
                    codeInitFunction = null; // Plain text code is handled in the template
                }


                couponContentHtml = `
                    <div class="receipt-font text-xs tracking-tight ${singleColumnAlignmentClass} coupon-content p-4">
                        
                        ${verticalFlow === 'top' ? singleCodeHtml(codeRenderType) : ''}

                        ${textBlock}
                        
                        ${verticalFlow === 'middle' ? singleCodeHtml(codeRenderType) : ''}
                        
                        ${verticalFlow === 'bottom' ? singleCodeHtml(codeRenderType) : ''}
                    </div>
                `;
            }

            // --- 4. Render Final HTML and Run Init Function ---
            const overlayHtml = hasBackgroundImage ? `<div class="preview-overlay"></div>` : '';

            elements.couponPreview.innerHTML = overlayHtml + couponContentHtml;

            if (codeInitFunction) {
                try {
                    codeInitFunction();
                } catch (error) {
                    console.warn(`Code generation error for ${codeRenderType}:`, error);
                }
            }
        };
        
        const downloadCouponPng = async () => {
            elements.downloadPngBtn.disabled = true;
            displayStatus('Generating image...', 'text-blue-600');
            
            try {
                const canvas = await html2canvas(elements.couponPreview, { 
                    scale: 3, 
                    backgroundColor: '#ffffff', 
                    useCORS: true 
                });

                await new Promise((resolve, reject) => {
                    canvas.toBlob(blob => {
                        if (!blob) { reject(new Error("Canvas failed to create Blob.")); return; }
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.download = 'coupon-receipt-' + elements.couponCode.value.toLowerCase() + '.png';
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                        resolve();
                    }, 'image/png');
                });
                
                displayStatus('PNG Download initiated!', 'text-green-600');

            } catch (error) {
                console.error("Error generating or downloading image:", error);
                displayStatus('Download failed. Please **Right-Click** the coupon and select **"Save Image As..."** instead.', 'text-red-600');
            } finally {
                elements.downloadPngBtn.disabled = false; 
            }
        };


        // --- Event Listeners ---
        document.getElementById('coupon-form').addEventListener('input', updateCouponPreview);
        elements.generateCodeBtn.addEventListener('click', (e) => { e.preventDefault(); elements.couponCode.value = generateRandomCode(); updateCouponPreview(); });
        elements.copyCouponBtn.addEventListener('click', () => {
            const previewDiv = elements.couponPreview;
            const textToCopy = Array.from(previewDiv.querySelectorAll('.coupon-content p:not(.barcode-text)')).map(p => p.textContent.trim()).join('\n');
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            displayStatus('Coupon text copied to clipboard!', 'text-green-600');
        });
        elements.downloadPngBtn.addEventListener('click', downloadCouponPng);
        elements.printCouponBtn.addEventListener('click', () => { window.print(); });
        elements.startCameraBtn.addEventListener('click', startCamera);
        elements.takePhotoBtn.addEventListener('click', takePhoto);
        elements.clearPhotoBtn.addEventListener('click', clearPhotoBackground);
        elements.imageUploadInput.addEventListener('change', handleImageUpload);
        elements.aiPrompt.addEventListener('input', checkAiButtonState);
        elements.generateAiCouponBtn.addEventListener('click', generateCouponWithAI);
        
        // Collapse listeners
        document.getElementById('coupon-details-header').addEventListener('click', () => {
            const isVisible = elements.couponInputContainer.style.maxHeight !== '0px';
            toggleForm(!isVisible);
        });
        document.getElementById('ai-generator-header').addEventListener('click', () => {
            const isVisible = elements.aiInputContainer.style.maxHeight !== '0px';
            toggleAiSection(!isVisible);
        });
        document.getElementById('photo-generator-header').addEventListener('click', () => {
            const isVisible = elements.photoInputContainer.style.maxHeight !== '0px';
            togglePhotoSection(!isVisible);
        });
        document.getElementById('gallery-header').addEventListener('click', () => {
            const isVisible = elements.galleryContentContainer.style.maxHeight !== '0px';
            // Use a large value (10000px) to ensure the entire gallery list is visible when expanded
            toggleSection(elements.galleryContentContainer, elements.galleryToggleIcon, !isVisible, '10000px'); 
        });
        
        // --- Initialization ---
        loadCoupons();
        updateCouponPreview();
    </script>
</body>
</html>
