<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Coupon Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Include html2canvas for image generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Include JsBarcode library for generating the barcode SVG -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font for UI, Roboto Mono for the receipt text */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        .receipt-font {
            font-family: 'Roboto Mono', monospace;
        }
        /* Custom dashed line for the tear-off effect */
        .perforation {
            border: none;
            border-top: 2px dashed #a0a0a0;
            margin: 1rem 0;
            opacity: 0.6;
        }
        /* Styling for the coupon output box */
        #coupon-preview {
            background-color: #ffffff;
            background-size: cover;
            background-position: center;
            color: #1f2937;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 0, 0.05);
            /* Added position relative for overlay and content layering */
            position: relative; 
            overflow: hidden;
            min-height: 250px; /* Ensure space for image */
        }
        /* Style for the overlay to ensure text readability over a background image */
        .preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.7); /* Semi-transparent white */
            z-index: 1; /* Below coupon content */
            border-radius: 0.5rem; /* Match parent rounded-lg */
        }
        /* Ensure coupon text content is above the overlay */
        .coupon-content {
            position: relative;
            z-index: 2;
        }
        /* Loading spinner style */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border-left-color: #ffffff;
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom pulse for voice input */
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse-slow {
          0%, 100% { opacity: 1; }
          50% { opacity: .5; }
        }
        
        /* --- PRINT STYLES --- */
        @media print {
            /* Hide everything that is not the coupon area */
            body > * {
                visibility: hidden;
            }
            
            /* Make the body suitable for printing */
            body {
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
            }

            /* Isolate and center the coupon preview container */
            #print-area {
                visibility: visible;
                position: absolute;
                left: 50%;
                top: 20px; /* Small margin from the top of the printed page */
                transform: translateX(-50%);
                width: 100%;
                max-width: 350px; /* Constrain size for a typical receipt/coupon look */
            }

            /* Remove non-print elements like shadows and borders */
            #coupon-preview {
                box-shadow: none !important;
                border: none !important;
                border-radius: 0 !important;
                background-color: white !important;
                /* Ensure background image is printed */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Hide the overlay to ensure color is not muted on print */
            .preview-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">POS Receipt Coupon Generator</h1>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Coupon Input Form (The entire left column) -->
            <div class="p-6 bg-white rounded-xl shadow-lg h-fit">
                
                <!-- Collapsible Header for Coupon Details (Open by Default) -->
                <div id="coupon-details-header" class="flex justify-between items-center cursor-pointer mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">Coupon Details</h2>
                    <!-- Icon: Chevron Up/Down to indicate toggle state -->
                    <svg id="toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
                </div>

                <form id="coupon-form">
                    <!-- Wrapper for Collapsing: Open by default -->
                    <div id="coupon-input-container" class="space-y-4 transition-all duration-500 ease-in-out overflow-hidden visible" style="max-height: 800px;">
                        
                        <!-- Discount Type and Value -->
                        <div class="flex space-x-4">
                            <div class="w-1/3">
                                <label for="discountType" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="discountType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                    <option value="%_OFF">% OFF</option>
                                    <option value="$_OFF">$ OFF</option>
                                    <option value="FREE_ITEM">FREE ITEM</option>
                                </select>
                            </div>
                            <div class="w-2/3">
                                <label for="discountValue" class="block text-sm font-medium text-gray-700">Value (e.g., 15 or Coffee)</label>
                                <input type="text" id="discountValue" value="15" placeholder="e.g., 15 or Coffee" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                        </div>

                        <!-- Custom Headline Input -->
                        <div>
                            <label for="customHeadline" class="block text-sm font-medium text-gray-700">Custom Headline (Overrides default)</label>
                            <input type="text" id="customHeadline" placeholder="e.g., 15% OFF YOUR NEXT PURCHASE" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <!-- Minimum Purchase -->
                        <div>
                            <label for="minPurchase" class="block text-sm font-medium text-gray-700">Min. Purchase (Optional)</label>
                            <input type="text" id="minPurchase" value="$50.00" placeholder="e.g., $50.00 or $0.00" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <!-- Expiration Date -->
                        <div>
                            <label for="expirationDate" class="block text-sm font-medium text-gray-700">Expiration Date</label>
                            <input type="date" id="expirationDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                        </div>

                        <!-- Coupon Code -->
                        <div>
                            <label for="couponCode" class="block text-sm font-medium text-gray-700">Coupon Code</label>
                            <div class="flex space-x-2">
                                <input type="text" id="couponCode" value="SUMMER2025" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border receipt-font uppercase font-bold text-center">
                                <button type="button" id="generateCode" class="mt-1 px-4 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700 transition duration-150 shadow-md">
                                    Generate
                                </button>
                            </div>
                        </div>
                        
                        <!-- Updated Barcode Placement Control -->
                        <div>
                            <label for="barcodePosition" class="block text-sm font-medium text-gray-700">Barcode Placement (Vertical & Horizontal)</label>
                            <select id="barcodePosition" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                <option value="middle-center">Middle (Center)</option>
                                <option value="middle-left">Middle (Left)</option>
                                <option value="middle-right">Middle (Right)</option>
                                <option value="top-center">Top (Center)</option>
                                <option value="bottom-center">Bottom (Center)</option>
                            </select>
                        </div>

                        <!-- Terms and Conditions -->
                        <div>
                            <label for="terms" class="block text-sm font-medium text-gray-700">Terms (Short)</label>
                            <textarea id="terms" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">Valid for one-time use. Excludes clearance items.</textarea>
                        </div>

                    </div>
                </form>

                <!-- AI Generation -->
                <div class="mt-8 pt-4 border-t border-gray-200">
                    <!-- Collapsible Header for AI (Default Collapsed) -->
                    <div id="ai-generator-header" class="flex justify-between items-center cursor-pointer mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">AI Coupon Generator</h2>
                        <!-- Icon: Rotate-180 for closed state -->
                        <svg id="ai-toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <!-- Wrapper for AI Content (Default collapsed) -->
                    <div id="ai-input-container" class="space-y-4 transition-all duration-500 ease-in-out overflow-hidden invisible" style="max-height: 0;">
                        
                        <!-- API Key Input -->
                        <div class="mb-4">
                            <label for="apiKeyInput" class="block text-sm font-medium text-gray-700">Gemini/Imagen API Key (Optional)</label>
                            <input type="password" id="apiKeyInput" placeholder="Enter your key here..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">
                            <p class="text-xs text-gray-500 mt-1">If empty, the environment's default key will be used.</p>
                        </div>

                        <p class="text-sm text-gray-500 mb-3">Describe the coupon you want (e.g., "A coupon for a free small coffee with $10 purchase, expiring end of month.")</p>
                        
                        <!-- AI Prompt and Voice Input -->
                        <div class="flex space-x-2">
                            <textarea id="aiPrompt" rows="3" placeholder="Enter your coupon description here..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-violet-500 focus:ring-violet-500 p-2 border">A coupon for a free small coffee with $10 purchase, expiring end of october 2025 with a happy store customer drinking coffee image.</textarea>
                            <button type="button" id="startVoiceInputBtn" title="Use Voice Input" class="mt-1 px-4 py-1.5 bg-blue-500 text-white text-sm font-medium rounded-md hover:bg-blue-600 transition duration-150 shadow-md h-12 self-start flex items-center justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7v0a7 7 0 01-7-7v0M12 19v3M12 4v0"></path></svg>
                            </button>
                        </div>

                        <button id="generateAiCouponBtn" class="w-full mt-3 px-4 py-2 bg-violet-600 text-white font-medium rounded-md hover:bg-violet-700 transition duration-150 shadow-md flex items-center justify-center">
                            <span id="ai-btn-text">Generate Coupon Draft with AI</span>
                            <div id="ai-loading-spinner" class="spinner ml-3 hidden"></div>
                        </button>
                    </div>
                </div>

                <!-- Camera/Upload Controls and Preview -->
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <!-- Collapsible Header for Photo (Default Collapsed) -->
                    <div id="photo-generator-header" class="flex justify-between items-center cursor-pointer mb-4">
                        <h2 class="text-xl font-semibold text-gray-700">Optional Background Photo</h2>
                        <!-- Icon: Rotate-180 for closed state -->
                        <svg id="photo-toggle-icon" class="w-6 h-6 text-gray-500 transform transition-transform duration-300 rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>

                    <!-- Wrapper for Photo Content (Default collapsed) -->
                    <div id="photo-input-container" class="space-y-4 transition-all duration-500 ease-in-out overflow-hidden invisible" style="max-height: 0;">
                        
                        <!-- Camera Controls -->
                        <div class="flex flex-col space-y-3">
                            <button id="startCameraBtn" class="px-4 py-2 bg-purple-600 text-white font-medium rounded-md hover:bg-purple-700 transition duration-150 shadow-md">
                                <span id="camera-btn-text">Start Camera</span>
                            </button>
                            <button id="takePhotoBtn" class="px-4 py-2 bg-orange-500 text-white font-medium rounded-md hover:bg-orange-600 transition duration-150 shadow-md hidden" disabled>
                                Take Photo & Set Background
                            </button>
                        </div>

                        <!-- Video stream and hidden capture canvas -->
                        <div class="mt-4 relative bg-gray-900 rounded-lg overflow-hidden hidden" id="camera-container">
                            <video id="cameraFeed" class="w-full h-auto object-cover" autoplay playsinline></video>
                            <canvas id="photoCanvas" class="hidden"></canvas>
                        </div>

                        <!-- Image Upload Input -->
                        <div class="pt-4 border-t border-gray-200 mt-4">
                            <label for="imageUploadInput" class="block text-base font-medium text-gray-700 mb-2">OR Upload Photo from Device</label>
                            <input type="file" id="imageUploadInput" accept="image/*" class="w-full text-sm text-gray-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-md file:border-0
                                file:text-sm file:font-semibold
                                file:bg-pink-50 file:text-pink-700
                                hover:file:bg-pink-100
                            ">
                        </div>

                        <!-- Clear Photo Button (Applies to both camera and upload) -->
                        <button id="clearPhotoBtn" class="w-full mt-4 px-4 py-2 bg-gray-500 text-white font-medium rounded-md hover:bg-gray-600 transition duration-150 shadow-md">
                            Clear Background Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- Coupon Preview & Controls -->
            <div class="p-6 bg-gray-100 rounded-xl">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">POS Receipt Preview</h2>
                
                <!-- Print Isolation Wrapper -->
                <div id="print-area" class="w-full max-w-sm mx-auto">
                    <div id="coupon-preview" class="p-4 border border-gray-200 rounded-lg shadow-2xl">
                        <!-- Dynamic content will be injected here -->
                    </div>
                </div>

                <div class="mt-6 text-center">
                    <!-- Consolidated status message area -->
                    <p id="statusMessage" class="h-5 text-sm font-medium transition duration-300 text-gray-700 mb-2 opacity-0">Status Message</p>
                    
                    <div class="flex flex-wrap justify-center gap-3">
                        <button id="copyCouponText" class="px-4 py-3 bg-green-500 text-white font-bold text-sm rounded-lg hover:bg-green-600 transition duration-150 shadow-md">
                            Copy Coupon Text
                        </button>
                        <button id="downloadCouponPng" class="px-4 py-3 bg-blue-500 text-white font-bold text-sm rounded-lg hover:bg-blue-600 transition duration-150 shadow-md">
                            Download as PNG
                        </button>
                        <button id="printCouponBtn" class="px-4 py-3 bg-indigo-500 text-white font-bold text-sm rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                            Print Coupon
                        </button>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        // --- Global Configuration ---
        const TEXT_MODEL = 'gemini-2.5-flash-preview-05-20';
        const IMAGE_MODEL = 'imagen-3.0-generate-002';
        const MAX_RETRIES = 5;
        const INITIAL_BACKOFF = 1000; // 1 second

        // --- Utility Functions ---

        /**
         * Converts a date object to a formatted string (MM/DD/YYYY).
         * @param {Date} date 
         * @returns {string} Formatted date string
         */
        const formatDate = (date) => {
            if (!date) return 'MM/DD/YYYY';
            const [year, month, day] = date.split('-');
            return `${month}/${day}/${year}`;
        };

        /**
         * Generates a random alphanumeric coupon code.
         * @returns {string} 10-character code
         */
        const generateRandomCode = () => {
            return Math.random().toString(36).substring(2, 12).toUpperCase();
        };

        /**
         * Exponential backoff utility for API retries.
         */
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // --- Core Application Logic ---

        const statusMessage = document.getElementById('statusMessage');

        const elements = {
            discountType: document.getElementById('discountType'),
            discountValue: document.getElementById('discountValue'),
            minPurchase: document.getElementById('minPurchase'),
            expirationDate: document.getElementById('expirationDate'),
            couponCode: document.getElementById('couponCode'),
            barcodePosition: document.getElementById('barcodePosition'), 
            terms: document.getElementById('terms'),
            customHeadline: document.getElementById('customHeadline'),
            couponPreview: document.getElementById('coupon-preview'),
            
            // Coupon Details Collapse Elements
            couponDetailsHeader: document.getElementById('coupon-details-header'),
            couponInputContainer: document.getElementById('coupon-input-container'),
            toggleIcon: document.getElementById('toggle-icon'),
            
            // AI Generator Collapse Elements
            aiGeneratorHeader: document.getElementById('ai-generator-header'),
            aiInputContainer: document.getElementById('ai-input-container'),
            aiToggleIcon: document.getElementById('ai-toggle-icon'),

            // Camera/Photo Collapse Elements (NEW)
            photoGeneratorHeader: document.getElementById('photo-generator-header'),
            photoInputContainer: document.getElementById('photo-input-container'),
            photoToggleIcon: document.getElementById('photo-toggle-icon'),
            
            // Buttons
            generateCodeBtn: document.getElementById('generateCode'),
            copyCouponBtn: document.getElementById('copyCouponText'),
            downloadPngBtn: document.getElementById('downloadCouponPng'),
            printCouponBtn: document.getElementById('printCouponBtn'),
            startCameraBtn: document.getElementById('startCameraBtn'),
            takePhotoBtn: document.getElementById('takePhotoBtn'),
            clearPhotoBtn: document.getElementById('clearPhotoBtn'),
            startVoiceInputBtn: document.getElementById('startVoiceInputBtn'),
            
            // Camera/Upload elements
            cameraBtnText: document.getElementById('camera-btn-text'),
            cameraContainer: document.getElementById('camera-container'),
            cameraFeed: document.getElementById('cameraFeed'),
            photoCanvas: document.getElementById('photoCanvas'),
            imageUploadInput: document.getElementById('imageUploadInput'),

            // AI Generation elements
            aiPrompt: document.getElementById('aiPrompt'),
            generateAiCouponBtn: document.getElementById('generateAiCouponBtn'),
            aiBtnText: document.getElementById('ai-btn-text'),
            aiLoadingSpinner: document.getElementById('ai-loading-spinner'),
            
            // API Key Input
            apiKeyInput: document.getElementById('apiKeyInput'), 
        };
        
        let mediaStream = null;
        let isCameraActive = false;
        let isListening = false;
        
        // --- Speech Recognition Setup ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                elements.startVoiceInputBtn.classList.add('bg-red-500', 'animate-pulse-slow');
                elements.startVoiceInputBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                displayStatus('Listening... Speak your coupon request now.', 'text-red-500');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                elements.aiPrompt.value = transcript;
                checkAiButtonState();
                displayStatus('Voice input recorded. Click Generate to proceed.', 'text-green-600');
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    displayStatus('Microphone permission denied. Please enable it in your browser settings.', 'text-red-600');
                } else if (event.error === 'no-speech') {
                    displayStatus('No speech detected. Try speaking closer to the mic.', 'text-orange-500');
                } else {
                    displayStatus(`Voice input error: ${event.error}`, 'text-red-600');
                }
            };

            recognition.onend = () => {
                isListening = false;
                elements.startVoiceInputBtn.classList.remove('bg-red-500', 'animate-pulse-slow');
                elements.startVoiceInputBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            };

            elements.startVoiceInputBtn.addEventListener('click', () => {
                if (!isListening) {
                    try {
                        elements.aiPrompt.value = '';
                        recognition.start();
                    } catch(e) {
                        displayStatus('Microphone start error. Wait a second and try again.', 'text-orange-500');
                    }
                } else {
                    recognition.stop();
                }
            });

        } else {
            elements.startVoiceInputBtn.style.display = 'none';
        }

        // Initialize expiration date to 30 days from now
        const today = new Date();
        const futureDate = new Date(today);
        futureDate.setDate(today.getDate() + 30);
        elements.expirationDate.value = futureDate.toISOString().split('T')[0];
        
        // Initialize custom headline with a default value
        const initialValue = elements.discountValue.value.trim();
        elements.customHeadline.value = `${initialValue || '15'}% OFF YOUR NEXT PURCHASE`;
        
        // Initial state check for AI button
        const checkAiButtonState = () => {
            elements.generateAiCouponBtn.disabled = elements.aiPrompt.value.trim().length < 5;
        };
        checkAiButtonState();


        /**
         * Displays a status message with specific text and color.
         */
        const displayStatus = (message, colorClass) => {
            statusMessage.textContent = message;
            statusMessage.className = `h-5 text-sm font-medium transition duration-300 mb-2 ${colorClass}`;
            statusMessage.classList.remove('opacity-0');
            
            // Hide message after a delay
            setTimeout(() => {
                statusMessage.classList.add('opacity-0');
            }, 5000);
        };
        
        /**
         * Toggles the visibility of a section with smooth transition using max-height style.
         * @param {Object} container - The content wrapper element.
         * @param {Object} icon - The chevron icon element.
         * @param {boolean} show - If true, expands the section; if false, collapses it.
         * @param {string} maxHeight - The max-height value (e.g., '800px') to use when expanding.
         */
        const toggleSection = (container, icon, show, maxHeight = '800px') => {
            if (show) {
                // Expand
                container.classList.remove('invisible');
                container.style.maxHeight = maxHeight; 
                icon.classList.add('rotate-0');
                icon.classList.remove('rotate-180');
            } else {
                // Collapse
                container.style.maxHeight = '0'; 
                container.classList.add('invisible'); 
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-180');
            }
        };

        /**
         * Toggles the visibility of the main coupon form inputs.
         */
        const toggleForm = (show) => {
            toggleSection(elements.couponInputContainer, elements.toggleIcon, show, '800px');
        };
        
        /**
         * Toggles the visibility of the AI Generator section.
         */
        const toggleAiSection = (show) => {
            toggleSection(elements.aiInputContainer, elements.aiToggleIcon, show, '400px');
        };

        /**
         * Toggles the visibility of the Optional Background Photo section.
         */
        const togglePhotoSection = (show) => {
            toggleSection(elements.photoInputContainer, elements.photoToggleIcon, show, '600px');
        };


        /**
         * Stops the camera stream.
         */
        const stopCamera = () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            elements.cameraFeed.srcObject = null;
            elements.cameraContainer.classList.add('hidden');
            elements.takePhotoBtn.classList.add('hidden');
            elements.takePhotoBtn.disabled = true;
            elements.cameraBtnText.textContent = 'Start Camera';
            elements.startCameraBtn.classList.remove('bg-red-600');
            elements.startCameraBtn.classList.add('bg-purple-600');
            isCameraActive = false;
        };

        /**
         * Starts the camera stream.
         */
        const startCamera = async () => {
            if (isCameraActive) {
                stopCamera();
                return;
            }

            try {
                displayStatus('Requesting camera access...', 'text-blue-600');
                mediaStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                elements.cameraFeed.srcObject = mediaStream;
                elements.cameraFeed.play();
                
                elements.cameraContainer.classList.remove('hidden');
                elements.takePhotoBtn.classList.remove('hidden');
                elements.takePhotoBtn.disabled = false;
                elements.cameraBtnText.textContent = 'Stop Camera';
                elements.startCameraBtn.classList.remove('bg-purple-600');
                elements.startCameraBtn.classList.add('bg-red-600');
                isCameraActive = true;
                elements.imageUploadInput.value = '';
                displayStatus('Camera started. Position the coupon background.', 'text-green-600');

            } catch (err) {
                console.error("Camera access failed:", err);
                displayStatus('Error: Camera access denied or unavailable.', 'text-red-600');
                stopCamera();
            }
        };

        /**
         * Captures a photo from the stream and sets it as the coupon background.
         */
        const takePhoto = () => {
            if (!isCameraActive) return;
            const video = elements.cameraFeed;
            const canvas = elements.photoCanvas;
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageDataURL = canvas.toDataURL('image/png');
            
            elements.couponPreview.style.backgroundImage = `url('${imageDataURL}')`;
            stopCamera();
            displayStatus('Photo captured and set as background!', 'text-green-600');
            updateCouponPreview();
        };

        /**
         * Handles local image file upload and sets it as the coupon background.
         */
        const handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            if (isCameraActive) stopCamera();

            if (!file.type.startsWith('image/')) {
                displayStatus('Please select an image file.', 'text-red-600');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const imageDataURL = e.target.result;
                elements.couponPreview.style.backgroundImage = `url('${imageDataURL}')`;
                displayStatus('Image uploaded and set as background!', 'text-green-600');
                updateCouponPreview();
            };
            
            reader.readAsDataURL(file);
        };

        /**
         * Clears the custom background photo.
         */
        const clearPhotoBackground = () => {
            elements.couponPreview.style.backgroundImage = 'none';
            elements.imageUploadInput.value = '';
            displayStatus('Background image cleared.', 'text-gray-600');
            updateCouponPreview(); 
            stopCamera();
        };

        // --- AI API CALLS ---

        const getApiKey = () => {
            return elements.apiKeyInput.value.trim();
        };

        const getApiUrl = (model) => {
            const key = getApiKey();
            return `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
        };

        const getImageApiUrl = (model) => {
            const key = getApiKey();
            return `https://generativelanguage.googleapis.com/v1beta/models/${model}:predict?key=${key}`;
        };


        /**
         * Calls the Imagen API to generate an image and returns a base64 URL.
         */
        const generateImage = async (prompt) => {
            const payload = { 
                instances: { prompt: prompt }, 
                parameters: { "sampleCount": 1 } 
            };

            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(getImageApiUrl(IMAGE_MODEL), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const base64Data = result.predictions?.[0]?.bytesBase64Encoded;
                        if (base64Data) {
                            return `data:image/png;base64,${base64Data}`;
                        }
                        throw new Error("Image API returned no image data.");
                    }
                    
                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        const delay = INITIAL_BACKOFF * Math.pow(2, attempt) + Math.random() * 1000;
                        await sleep(delay);
                        continue;
                    }
                    
                    throw new Error(`Image API call failed with status: ${response.status}`);
                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) {
                        throw new Error(`Image generation failed after ${MAX_RETRIES} attempts: ${error.message}`);
                    }
                }
            }
        };

        /**
         * Calls the Gemini API to generate coupon details with exponential backoff.
         */
        const callGeminiApi = async (payload) => {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    const response = await fetch(getApiUrl(TEXT_MODEL), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response.json();
                    }
                    
                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        const delay = INITIAL_BACKOFF * Math.pow(2, attempt) + Math.random() * 1000;
                        await sleep(delay);
                        continue;
                    }

                    throw new Error(`API call failed with status: ${response.status}`);
                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) {
                        throw new Error(`Gemini API request failed after ${MAX_RETRIES} attempts: ${error.message}`);
                    }
                }
            }
        };

        /**
         * Constructs the API payload with the JSON schema for structured output.
         */
        const buildAiPayload = (prompt) => {
            const systemInstruction = "You are a coupon generator AI. Based on the user's request, generate a complete set of coupon details in the requested JSON format. Ensure all fields are valid, especially the expirationDate (YYYY-MM-DD, future date, set to the end of the specified month/year) and one of the allowed discountType values. Ignore any image requests in the prompt, as the image is handled separately.";
            
            return {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "discountType": { "type": "STRING", "enum": ["%_OFF", "$_OFF", "FREE_ITEM"] },
                            "discountValue": { "type": "STRING", "description": "The numeric value (e.g., '20') for %_OFF or $_OFF, or the item name (e.g., 'Small Coffee') for FREE_ITEM." },
                            "customHeadline": { "type": "STRING", "description": "A short, attention-grabbing headline for the coupon, e.g., 'WEEKEND SAVINGS EVENT'. Should be less than 40 characters." },
                            "minPurchase": { "type": "STRING", "description": "Minimum purchase requirement, including currency sign, e.g., '$50.00'. Use empty string if none." },
                            "expirationDate": { "type": "STRING", "description": "The coupon's expiration date in YYYY-MM-DD format, set to the requested future date." },
                            "couponCode": { "type": "STRING", "description": "A unique, uppercase alphanumeric code, e.g., 'FALL2025'." },
                            "terms": { "type": "STRING", "description": "Short terms and conditions (max 10 words)." }
                        },
                        "required": ["discountType", "discountValue", "customHeadline", "minPurchase", "expirationDate", "couponCode", "terms"]
                    }
                }
            };
        };

        /**
         * Handles the entire AI coupon generation process (Image + Text).
         */
        const generateCouponWithAI = async () => {
            const prompt = elements.aiPrompt.value.trim();
            if (prompt.length < 5) {
                displayStatus('Please enter a longer, more specific prompt.', 'text-red-500');
                return;
            }

            // Collapse the main form and photo sections, expand the AI form to show the prompt
            toggleForm(false);
            togglePhotoSection(false);
            toggleAiSection(true); 

            // 1. Clear existing content (but preserve image) and show combined loading state
            const hasExistingImage = elements.couponPreview.style.backgroundImage !== 'none' && elements.couponPreview.style.backgroundImage !== '';
            const loadingOverlay = hasExistingImage ? `<div class="preview-overlay"></div>` : '';
            elements.couponPreview.innerHTML = loadingOverlay + `
                <div class="p-4 text-center text-gray-500 receipt-font coupon-content">
                    <p class="text-lg font-semibold mb-2">Generating Image and Coupon Details...</p>
                    <p class="text-sm">This may take a few moments.</p>
                </div>
            `;
            elements.imageUploadInput.value = ''; 
            
            // 2. Set loading state
            elements.generateAiCouponBtn.disabled = true;
            elements.aiBtnText.textContent = 'Generating...';
            elements.aiLoadingSpinner.classList.remove('hidden');
            displayStatus('AI is drafting your coupon details and image...', 'text-violet-600');

            try {
                // A. IMAGE GENERATION (First Step)
                displayStatus('Step 1/2: Generating background image (This can take 5-10s)...', 'text-purple-600');
                const imagePromptDescription = prompt.includes('image') ? prompt.substring(prompt.indexOf('image') - 2) : "A happy store customer drinking coffee, inside a modern cafe, clean photo, mobile friendly aspect ratio.";
                
                const imageUrl = await generateImage(imagePromptDescription);
                elements.couponPreview.style.backgroundImage = `url('${imageUrl}')`;
                
                // Re-apply a visible loading overlay over the new image while we wait for text
                const currentOverlay = elements.couponPreview.querySelector('.preview-overlay');
                if (!currentOverlay) {
                     elements.couponPreview.innerHTML = `<div class="preview-overlay"></div>` + elements.couponPreview.innerHTML; 
                }

                // B. TEXT GENERATION (Second Step)
                displayStatus('Step 2/2: Generating coupon details...', 'text-violet-600');
                const payload = buildAiPayload(prompt);
                const result = await callGeminiApi(payload);
                
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                     throw new Error('AI response was empty or malformed.');
                }
                
                const couponData = JSON.parse(jsonText);

                // Populate form fields with AI data
                elements.discountType.value = couponData.discountType || elements.discountType.value;
                elements.discountValue.value = couponData.discountValue || elements.discountValue.value;
                elements.customHeadline.value = couponData.customHeadline || '';
                elements.minPurchase.value = couponData.minPurchase || '';
                elements.couponCode.value = couponData.couponCode || generateRandomCode();
                elements.terms.value = couponData.terms || elements.terms.value;
                
                if (couponData.expirationDate) {
                    const dateMatch = couponData.expirationDate.match(/\d{4}-\d{2}-\d{2}/);
                    if (dateMatch) {
                         elements.expirationDate.value = dateMatch[0];
                    }
                }

                updateCouponPreview(); // This call will correctly render the new content over the preserved image
                displayStatus('AI coupon and image generated successfully! Review and download.', 'text-green-600');

            } catch (error) {
                console.error('AI Generation Error:', error);
                if (error.message.includes('Image generation failed')) {
                    elements.couponPreview.style.backgroundImage = 'none';
                    elements.couponPreview.innerHTML = '';
                }
                displayStatus(`Error generating coupon: ${error.message || 'Could not parse AI response.'}`, 'text-red-600');
                updateCouponPreview();
            } finally {
                // Reset loading state
                elements.generateAiCouponBtn.disabled = false;
                elements.aiBtnText.textContent = 'Generate Coupon Draft with AI';
                elements.aiLoadingSpinner.classList.add('hidden');
                
                // CRITICAL STEP: Expand the main form inputs after generation completes
                toggleForm(true); 
            }
        };

        // --- Preview and Download Logic ---

        /**
         * Reads input and updates the visual coupon preview.
         */
        const updateCouponPreview = () => {
            const type = elements.discountType.value;
            const value = elements.discountValue.value.trim();
            const min = elements.minPurchase.value.trim();
            const expiry = elements.expirationDate.value;
            const code = elements.couponCode.value.trim() || 'NOCODE';
            const terms = elements.terms.value.trim();
            const customHeadline = elements.customHeadline.value.trim(); 
            const position = elements.barcodePosition.value; 
            
            const [verticalFlow, horizontalAlign] = position.split('-');

            let discountLine = '';
            let headline = '';
            let barcodeBlock = '';

            let justifyClass = 'justify-center';
            if (horizontalAlign === 'left') {
                justifyClass = 'justify-start';
            } else if (horizontalAlign === 'right') {
                justifyClass = 'justify-end';
            }

            const hasBackgroundImage = elements.couponPreview.style.backgroundImage !== 'none' && elements.couponPreview.style.backgroundImage !== '';

            switch (type) {
                case '%_OFF':
                    headline = customHeadline || `${value || 'XX'}% OFF YOUR NEXT PURCHASE`;
                    discountLine = `${value || 'XX'}% DISCOUNT`;
                    break;
                case '$_OFF':
                    headline = customHeadline || `${value || '$X.XX'} OFF YOUR NEXT PURCHASE`;
                    discountLine = `SAVE ${value || '$X.XX'}`;
                    break;
                case 'FREE_ITEM':
                    headline = customHeadline || `FREE ${value || 'ITEM NAME'}`;
                    discountLine = `FREE ITEM: ${value || 'ITEM'}`;
                    break;
            }
            
            barcodeBlock = `
                <p class="text-xs font-bold mt-2">SCAN TO REDEEM:</p>
                <div class="flex ${justifyClass} my-2 w-full">
                    <svg id="barcode-svg" class="h-16 max-w-[200px] bg-white p-1 rounded-sm border border-gray-300"></svg>
                </div>
            `;

            const couponContentHtml = `
                <div class="receipt-font text-xs tracking-tight text-center coupon-content p-4">
                    
                    ${verticalFlow === 'top' ? barcodeBlock : ''}

                    <p class="text-xs mb-1">------------------------------------------</p>
                    <p class="font-bold text-lg leading-tight mb-2 uppercase text-indigo-700">${headline}</p>
                    
                    <hr class="perforation">
                    
                    <p class="text-sm font-semibold mb-1">${discountLine}</p>
                    
                    ${min ? `<p class="text-xs mb-1">WITH MINIMUM PURCHASE OF: ${min}</p>` : ''}

                    ${verticalFlow === 'middle' ? barcodeBlock : ''}
                    
                    <p class="text-xs font-semibold mt-1">EXPIRES: ${formatDate(expiry)}</p>
                    
                    <hr class="perforation">

                    ${terms ? `<p class="text-xs italic px-2">${terms}</p>` : '<p class="text-xs italic px-2">Valid only at participating locations.</p>'}
                    
                    ${verticalFlow === 'bottom' ? barcodeBlock : ''}

                    <p class="text-xs mt-3">------------------------------------------</p>
                    <p class="text-xs mt-1">** PRESENT RECEIPT TO REDEEM **</p>
                </div>
            `;
            
            const overlayHtml = hasBackgroundImage ? `<div class="preview-overlay"></div>` : '';

            elements.couponPreview.innerHTML = overlayHtml + couponContentHtml;

            try {
                if (code) {
                    JsBarcode("#barcode-svg", code, {
                        format: "CODE128",
                        displayValue: true,
                        text: code,
                        textPosition: "bottom",
                        fontSize: 12,
                        height: 50,
                        margin: 0,
                        width: 1.5,
                        lineColor: "#1f2937",
                        background: "transparent"
                    });
                }
            } catch (error) {
                console.warn("Barcode generation error (Check coupon code validity for CODE128):", error);
            }
        };
        
        /**
         * Converts the coupon preview to a PNG image and triggers a download.
         */
        const downloadCouponPng = async () => {
            elements.downloadPngBtn.disabled = true;
            displayStatus('Generating image...', 'text-blue-600');
            
            try {
                const canvas = await html2canvas(elements.couponPreview, { 
                    scale: 3, 
                    backgroundColor: '#ffffff', 
                    useCORS: true 
                });

                await new Promise((resolve, reject) => {
                    canvas.toBlob(blob => {
                        if (!blob) {
                            reject(new Error("Canvas failed to create Blob."));
                            return;
                        }
                        
                        const url = URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.download = 'coupon-receipt-' + elements.couponCode.value.toLowerCase() + '.png';
                        link.href = url;
                        
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        URL.revokeObjectURL(url);
                        resolve();

                    }, 'image/png');
                });
                
                displayStatus('PNG Download initiated!', 'text-green-600');

            } catch (error) {
                console.error("Error generating or downloading image:", error);
                displayStatus('Download failed. Please **Right-Click** the coupon and select **"Save Image As..."** instead.', 'text-red-600');
            } finally {
                elements.downloadPngBtn.disabled = false; 
            }
        };


        // --- Event Listeners ---

        // 1. Real-time update listener for form changes
        document.getElementById('coupon-form').addEventListener('input', updateCouponPreview);
        
        // 2. Coupon Code generation button
        elements.generateCodeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            elements.couponCode.value = generateRandomCode();
            updateCouponPreview();
        });

        // 3. Copy Coupon Text button
        elements.copyCouponBtn.addEventListener('click', () => {
            const previewDiv = elements.couponPreview;
            const textToCopy = Array.from(previewDiv.querySelectorAll('.coupon-content p:not(.barcode-text)')).map(p => p.textContent.trim()).join('\n');
            
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);

            displayStatus('Coupon text copied to clipboard!', 'text-green-600');
        });
        
        // 4. Download as PNG button
        elements.downloadPngBtn.addEventListener('click', downloadCouponPng);

        // 5. Print Coupon button
        elements.printCouponBtn.addEventListener('click', () => {
            window.print();
        });

        // 6. Camera controls
        elements.startCameraBtn.addEventListener('click', startCamera);
        elements.takePhotoBtn.addEventListener('click', takePhoto);
        elements.clearPhotoBtn.addEventListener('click', clearPhotoBackground);

        // 7. Image Upload listener
        elements.imageUploadInput.addEventListener('change', handleImageUpload);

        // 8. AI Prompt change listener to enable/disable button
        elements.aiPrompt.addEventListener('input', checkAiButtonState);

        // 9. AI Coupon Generation button - Uses the AI generation function
        elements.generateAiCouponBtn.addEventListener('click', generateCouponWithAI);
        
        // 10. Manual form collapse/expand listener for COUPON DETAILS
        elements.couponDetailsHeader.addEventListener('click', () => {
            const isVisible = elements.couponInputContainer.style.maxHeight !== '0px';
            toggleForm(!isVisible);
        });
        
        // 11. Manual form collapse/expand listener for AI GENERATOR
        elements.aiGeneratorHeader.addEventListener('click', () => {
            const isVisible = elements.aiInputContainer.style.maxHeight !== '0px';
            toggleAiSection(!isVisible);
        });
        
        // 12. Manual form collapse/expand listener for OPTIONAL BACKGROUND PHOTO (NEW)
        elements.photoGeneratorHeader.addEventListener('click', () => {
            const isVisible = elements.photoInputContainer.style.maxHeight !== '0px';
            togglePhotoSection(!isVisible);
        });
        
        // Initialize the view on load
        updateCouponPreview();

    </script>
</body>
</html>
